---
title: "Reporte"
author: "Valentina Rodríguez"
date: "2025-05-14"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(networkD3)
library(shiny)
datos_crudos <- read_excel("datosReporte.xlsx")
```

```{r}
datoss <- datos_crudos[1:12, -c(1,2,4)]

datos <- datoss %>%
 mutate(across(2:62, as.numeric))

datos1 <- datos %>%
  pivot_longer(
    cols = ends_with("]"),
    names_to = "Año",
    values_to = "Valor"
  ) %>%
  rename(Indicador = `Series Name`)

datos2 <- datos1 %>%
  pivot_wider(
    names_from = Indicador, 
    values_from = Valor
  )

datos1 <- datos1 %>%
  mutate(Año = sub("\\[.*", "", Año))

datos1$Año <- as.numeric(datos1$Año)

datos2 <- datos2 %>%
  mutate(Año = sub("\\[.*", "", Año))

datos2$Año <- as.numeric(datos2$Año)

datos1$Indicador <- recode(datos1$Indicador,
  "Population ages 0-14 (% of total population)" = "0-14 años",
  "Population ages 15-64 (% of total population)" = "15-64 años",
  "Population ages 65 and above (% of total population)" = "65+ años"
)

```





```{r}

ui <- navbarPage("Reporte Demográfico - Uruguay",
                 
  tabPanel("Introducción",
           fluidPage(
             titlePanel("Introducción"),
             p("Este reporte analiza variables poblacionales de Uruguay en base a datos del Banco Mundial. 
                Se abordan temas como envejecimiento, estructura etaria y dinámica poblacional.")
           )
  ),
  
  tabPanel("Estructura por edad",
           fluidPage(
             titlePanel("Distribución por grupo etario"),
             sidebarLayout(
               sidebarPanel(
                 selectInput("Año", "Seleccioná un año:", 
                             choices = c(1990, 2025, 2050), selected = 2025)
               ),
               mainPanel(
                 sankeyNetworkOutput("sankey_plot") # Aquí pondremos el Sankey luego
               )
             )
           )
  ),
  
  tabPanel("Evolución temporal",
           fluidPage(
             titlePanel("Indicadores a lo largo del tiempo"),
             sidebarLayout(
               sidebarPanel(
                 selectInput("variable", "Seleccioná una variable:",
                             choices = c("Esperanza de vida", "Tasa de natalidad", "Migración neta"))
               ),
               mainPanel(
                 plotOutput("line_plot")
               )
             )
           )
  ),
  
  tabPanel("Proporciones etarias",
           fluidPage(
             titlePanel("Cambios en proporciones etarias"),
             plotOutput("area_invertida")
           )
  ),
  
  tabPanel("Conclusiones",
           fluidPage(
             titlePanel("Conclusiones"),
             p("El análisis evidencia una clara tendencia al envejecimiento poblacional en Uruguay, con un aumento de la población de 65+ y una reducción de la población menor de 15."),
             p("Esto genera desafíos importantes para el sistema previsional, lo que refuerza la importancia de este tipo de análisis en instituciones como las AFAP.")
           )
  )
)

server <- function(input, output) {
  
  # Filtrar los datos para el gráfico de Sankey
datos_sankey <- datos1 %>%
  filter(!is.na(Indicador), Año %in% años_seleccionados) %>%
  mutate(Año = as.character(Año),
         Indicadot = as.character(Indicador))


pop_sankey <- datos_sankey %>%
  mutate(Año = as.character(Año),
         Indicador = as.character(Indicador))

# Crear nodos únicos
nodos <- data.frame(name = unique(c(pop_sankey$Año, pop_sankey$Indicador)))


  
  # Renderizar gráfico Sankey
  output$sankey_plot <- renderSankeyNetwork({
    
   # Crear enlaces con IDs
# Crear enlaces con IDs correctos para el gráfico Sankey
enlaces <- datos_sankey %>% 
  mutate(source = match(Año, nodos$name) - 1,
         target = match(Indicador, nodos$name) - 1) %>%
  select(source, target, Valor)


# Graficar
sankeyNetwork(Links = enlaces,
              Nodes = nodos,
              Source = "source",
              Target = "target",
              Value = "Valor",
              NodeID = "name",
              fontSize = 12,
              nodeWidth = 30)
  })
  
}

shinyApp(ui = ui, server = server)

```


usado:
```{r}

ui <- navbarPage("Reporte Demográfico - Uruguay",
                 
  tabPanel("Introducción",
           fluidPage(
             titlePanel("Introducción"),
             p("Este reporte analiza variables poblacionales de Uruguay en base a datos del Banco Mundial. 
                Se abordan temas como envejecimiento, estructura etaria y dinámica poblacional.")
           )
  ),
  
  tabPanel("Estructura por edad",
           fluidPage(
             titlePanel("Distribución por grupo etario"),
             sidebarLayout(
               sidebarPanel(
                 selectInput("Año", "Seleccioná un año intermedio:", 
            choices = unique(datos1$Año[datos1$Año != 1990 & datos1$Año != 2050]),
            selected = 2022)

               ),
               mainPanel(
                 sankeyNetworkOutput("sankey_plot") # Aquí pondremos el Sankey luego
               )
             )
           )
  ),
  
  tabPanel("Evolución temporal",
           fluidPage(
             titlePanel("Indicadores a lo largo del tiempo"),
             sidebarLayout(
               sidebarPanel(
                 selectInput("variable", "Seleccioná una variable:",
                             choices = c("Esperanza de vida", "Tasa de natalidad", "Migración neta"))
               ),
               mainPanel(
                 plotOutput("line_plot")
               )
             )
           )
  ),
  
  tabPanel("Proporciones etarias",
           fluidPage(
             titlePanel("Cambios en proporciones etarias"),
             plotOutput("area_invertida")
           )
  ),
  
  tabPanel("Conclusiones",
           fluidPage(
             titlePanel("Conclusiones"),
             p("El análisis evidencia una clara tendencia al envejecimiento poblacional en Uruguay, con un aumento de la población de 65+ y una reducción de la población menor de 15."),
             p("Esto genera desafíos importantes para el sistema previsional, lo que refuerza la importancia de este tipo de análisis en instituciones como las AFAP.")
           )
  )
)

server <- function(input, output) {
  
  output$sankey_plot <- renderSankeyNetwork({
    
  # Años que queremos mostrar
años_seleccionados <- c(1990, input$Año, 2050)
    
    # Filtrar datos
    datos_sankey <- datos1 %>%
      filter(Indicador %in% c("0-14 años", "15-64 años", "65+ años"),
             Año %in% años_seleccionados) %>%
      rename(grupoEtario = Indicador) %>%
      mutate(Año = as.character(Año),
             grupoEtario = as.character(grupoEtario))
    
    # Asegurarnos de que los grupos etarios están ordenados correctamente
    datos_sankey$grupoEtario <- factor(datos_sankey$grupoEtario, 
                                       levels = c("0-14 años", "15-64 años", "65+ años"))
    
    
nodos <- data.frame(name = c(as.character(años_seleccionados), 
                             "0-14 años", "15-64 años", "65+ años"))

    
    # Crear enlaces
    enlaces <- datos_sankey %>%
      mutate(source = match(Año, nodos$name) - 1,
             target = match(grupoEtario, nodos$name) - 1) %>%
      select(source, target, Valor)
    
    # Crear gráfico Sankey
  sn <-  sankeyNetwork(Links = enlaces,
              Nodes = nodos,
              Source = "source",
              Target = "target",
              Value = "Valor",
              NodeID = "name",
              fontSize = 12,
              nodeWidth = 30,
              colourScale = JS("d3.scaleOrdinal()
                      .domain(['0-14', '15-64', '65+', '1990', '2025', '2050'])
                      .range(['#E7969C', '#E7969C', '#E7969C', '#E7969C', '#E7969C', '#E7969C'])"),
              iterations = 0)  # ← Esto congela el orden

htmlwidgets::onRender(sn, '
  function(el, x) {
    // Cambiar tooltip de los links (líneas)
    d3.select(el).selectAll(".link").select("title")
      .text(function(d) {
        return d.value.toFixed(1) + "%";
      });

    // Ocultar tooltip de los nodos (rectángulos)
    d3.select(el).selectAll(".node").select("title").text("");
  }
')



  })
}


shinyApp(ui = ui, server = server)

```

```{r}
poblacion <- datos2[,c(1,13)]

poblacion <- poblacion %>%
  arrange(Año) %>%
  mutate(tasa_crecimiento = (`Population, total` - lag(`Population, total`)) / lag(`Population, total`) * 100)

```

```{r}
ggplot(poblacion, aes(x = Año)) +
  geom_area(aes(y = poblacion$`Population, total`), fill = "#99c2ff", alpha = 0.6) +
  geom_line(aes(y = poblacion$tasa_crecimiento * max(poblacion$`Population, total`, na.rm = TRUE) / max(poblacion$tasa_crecimiento, na.rm = TRUE)), 
            color = "red", size = 1.2) +
  scale_y_continuous(
    name = "Población total",
    sec.axis = sec_axis(~ . * max(poblacion$tasa_crecimiento, na.rm = TRUE) / max(poblacion$`Population, total`, na.rm = TRUE),
                        name = "Tasa de crecimiento (%)")
  ) +
  theme_minimal() +
  labs(title = "Población total y tasa de crecimiento anual",
       x = "Año")

```

```{r}
# Escalar la tasa de crecimiento para que se alinee visualmente con la población
escala <- max(datos2$Poblacion_total, na.rm = TRUE) / max(datos2$tasa_crecimiento, na.rm = TRUE)

ggplot(poblacion, aes(x = Año)) +
  geom_area(aes(y = Poblacion_total), fill = "#CCE5FF", alpha = 0.7) +
  geom_line(aes(y = tasa_crecimiento * escala), color = "#FF5733", size = 1.2) +
  scale_y_continuous(
    name = "Población total",
    sec.axis = sec_axis(~ . / escala, name = "Tasa de crecimiento (%)")
  ) +
  theme_minimal(base_size = 14) +
  labs(
    title = "Evolución de la población y tasa de crecimiento anual en Uruguay",
    x = "Año"
  ) +
  theme(
    axis.title.y.left = element_text(color = "#3366CC"),
    axis.title.y.right = element_text(color = "#FF5733"),
    plot.title = element_text(face = "bold", hjust = 0.5)
  )

```


NO VA

```{r}
library(networkD3)

output$sankey_plot <- renderSankeyNetwork({

datos_sankey <- datos1 %>%
  filter(Indicador %in% c("Population ages 0-14 (% of total population)", "Population ages 15-64 (% of total population)", "Population ages 65 and above (% of total population)"), Año %in% c(1990, 2022, 2050)) %>%
  rename(grupoEtario = Indicador)

pop_sankey <- datos_sankey %>%
  mutate(Año = as.character(Año),
         grupoEtario = as.character(grupoEtario))

# Crear nodos únicos
nodos <- data.frame(name = unique(c(pop_sankey$Año, pop_sankey$grupoEtario)))

# Crear enlaces con IDs
enlaces <- pop_sankey %>%
  mutate(source = match(Año, nodos$name) - 1,
         target = match(grupoEtario, nodos$name) - 1) %>%
  select(source, target, Valor)

# Graficar
sankeyNetwork(Links = enlaces,
              Nodes = nodos,
              Source = "source",
              Target = "target",
              Value = "Valor",
              NodeID = "name",
              fontSize = 12,
              nodeWidth = 30)

})
```

```{r}
library(networkD3)

output$sankey_plot <- renderSankeyNetwork({

datos_sankey <- datos1 %>%
  filter(Indicador %in% c("Population ages 0-14 (% of total population)", "Population ages 15-64 (% of total population)", "Population ages 65 and above (% of total population)"), Año %in% c(1990, 2022, 2050)) %>%
  rename(grupoEtario = Indicador)

pop_sankey <- datos_sankey %>%
  mutate(Año = as.character(Año),
         grupoEtario = as.character(grupoEtario))

# Crear nodos únicos
nodos <- data.frame(name = unique(c(pop_sankey$Año, pop_sankey$grupoEtario)))

# Crear enlaces con IDs
enlaces <- pop_sankey %>%
  mutate(source = match(Año, nodos$name) - 1,
         target = match(grupoEtario, nodos$name) - 1) %>%
  select(source, target, Valor)

# Graficar
sankeyNetwork(Links = enlaces,
              Nodes = nodos,
              Source = "source",
              Target = "target",
              Value = "Valor",
              NodeID = "name",
              fontSize = 12,
              nodeWidth = 30)

})
```

```{r}
library(shiny)

ui <- navbarPage("Reporte Demográfico - Uruguay",
                 
  tabPanel("Introducción",
           fluidPage(
             titlePanel("Introducción"),
             p("Este reporte analiza variables poblacionales de Uruguay en base a datos del Banco Mundial. 
                Se abordan temas como envejecimiento, estructura etaria y dinámica poblacional.")
           )
  ),
  
  tabPanel("Estructura por edad",
           fluidPage(
             titlePanel("Distribución por grupo etario"),
             sidebarLayout(
               sidebarPanel(
                 selectInput("year_sankey", "Seleccioná un año:", 
                             choices = c(1990, 2025, 2050), selected = 2025)
               ),
               mainPanel(
                 plotOutput("sankey_plot") # Aquí pondremos el Sankey luego
               )
             )
           )
  ),
  
  tabPanel("Evolución temporal",
           fluidPage(
             titlePanel("Indicadores a lo largo del tiempo"),
             sidebarLayout(
               sidebarPanel(
                 selectInput("variable", "Seleccioná una variable:",
                             choices = c("Esperanza de vida", "Tasa de natalidad", "Migración neta"))
               ),
               mainPanel(
                 plotOutput("line_plot")
               )
             )
           )
  ),
  
  tabPanel("Proporciones etarias",
           fluidPage(
             titlePanel("Cambios en proporciones etarias"),
             plotOutput("area_invertida")
           )
  ),
  
  tabPanel("Conclusiones",
           fluidPage(
             titlePanel("Conclusiones"),
             p("El análisis evidencia una clara tendencia al envejecimiento poblacional en Uruguay, con un aumento de la población de 65+ y una reducción de la población menor de 15."),
             p("Esto genera desafíos importantes para el sistema previsional, lo que refuerza la importancia de este tipo de análisis en instituciones como las AFAP.")
           )
  )
)

server <- function(input, output) {
  # Gráficos se irán agregando luego
}

shinyApp(ui = ui, server = server)

```